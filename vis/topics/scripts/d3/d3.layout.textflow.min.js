(function(){var e,G=1,X=Math.PI/180,o=1<<11>>5,x=1<<11;var k=d3.scale.category20b();var p=d3.scale.category10();var Y=d3.rgb(129,207,251);var J=d3.rgb(166,223,249);if(typeof document!=="undefined"){e=document.createElement("canvas");e.width=1;e.height=1;e.width=(o<<5)/G;e.height=x/G}else{e=new Canvas(o<<5,x)}var ab=e.getContext("2d");ab.fillStyle=ab.strokeStyle="red";ab.textAlign="center";G=Math.sqrt(ab.getImageData(0,0,1,1).data.length>>2);var d,M,F,s,L=-1,D,E=[1,40],r,n,t=j,Z=C,l=K,W=R,z=R,V=a,ac=d3.dispatch("word","end"),f="normal",I;var h,T;var P=O,v=Infinity,ac=d3.dispatch("word","end"),w=null;d3.layout.textflow=function(){s=d3.scale.category10();function ak(ar){I=ar;var au=ar.append("g");D=au;n=S();r=B();F=aa(M);h=d3.scale.linear().domain([0,F[0].length-1]).range([0,d[0]]);T=d3.scale.linear().domain([0,1]).range([d[1],0]);var av=d3.svg.area().x(function(aw){return h(aw.x)}).y0(function(aw){return T(aw.y0)}).y1(function(aw){return T(aw.y0+aw.y)}).interpolate("cardinal");var aq=au.selectAll(".flow").data(F).enter().append("path").attr("class","flow").attr("d",av).style("fill",function(ax,aw){if(aw%2==0){return J}return Y}).style("fill-opacity",1);if(w){clearInterval(w)}w=setInterval(af,100);var at=af();var ap=au.selectAll(".tag").data(at).enter().append("text").attr("class","tag").text(function(aw){return aw.text}).attr("text-anchor","middle").attr("transform",function(aw){return"translate("+[aw.x,aw.y]+")"}).style("font-size",function(aw){return aw.size+"px"}).style("opacity",0.000001).transition().duration(1000).style("opacity",1).style("font-family",function(aw){return aw.font}).style("fill",function(aw){return d3.rgb("black")});ah(f)}function af(){var aH=true;var au=[];var aL=F.length;for(var ax=0;ax<aL;ax++){var aM=F[ax],aw=g(aM,d),av=null;var ar=F[ax].topic_id;var aF=M[ar].periods,aq=aM.length;for(var ay=0;ay<aq-1;ay++){av=null;var aG=ay+n[0];var aD=aF[aG].wordlist,aI=aD.length,aC=-1;var aN=new Array();for(var aJ in aD){var aK=new Object();aK.word=aJ;aK.wordWeight=aD[aJ];aK.text=t.call(this,aK);aK.font=Z.call(this,aK);aK.style=W.call(this,aK);aK.weight=z.call(this,aK);aK.size=~~l.call(this,aK);aK.padding=a.call(this,aK);aN.push(aK)}aN.sort(function(aP,aO){return aO.size-aP.size});var aI=aN.length;var aB=Math.min(aM[ay].y0,aM[ay+1].y0),aE=Math.max(aM[ay].y0+aM[ay].y,aM[ay+1].y0+aM[ay+1].y);var aA=d3.scale.linear().domain([0,2]).range([h(ay),h(ay+1)]);var az=d3.scale.linear().domain([0,2]).range([T(aE),T(aB)]);var ap={};ap.xL=h(ay);ap.xH=h(ay+1);ap.yH=T(aB);ap.yL=T(aE);var at=+new Date,aJ;while((++aC<aI)&&(+new Date-at<v)&&w){aJ=aN[aC];aJ.x=~~aA(Math.random()+0.5);aJ.y=~~az(Math.random()+0.5);b(aJ,aN,aC);if(aJ.hasText&&c(aw,aJ,av,ap)){ac.word(aJ);au.push(aJ);if(av){q(av,aJ)}else{av=[{x:aJ.x+aJ.x0,y:aJ.y+aJ.y0},{x:aJ.x+aJ.x1,y:aJ.y+aJ.y1}]}}}if(aC<aI){aH=false}}}if(aH==true){if(w){clearInterval(w);w=null}}return au}function c(ax,aR,aw,ap){var av=[{x:0,y:0},{x:d[0],y:d[1]}],aO=aR.x,aN=aR.y,aq=Math.sqrt((ap.xH-ap.xL)*(ap.xH-ap.xL)+(ap.yH-ap.yL)*(ap.yH-ap.yL)),aE=P(d),aF=Math.random()<0.5?1:-1,aD=-aF,aK,aC,aA;while(aK=aE(aD+=aF)){aC=~~aK[0];aA=~~aK[1];if(Math.min(aC,aA)>aq){break}aR.x=aO+aC;aR.y=aN+aA;if(aR.x+aR.x0<ap.xL||aR.y+aR.y0<ap.yL||aR.x+aR.x1>ap.xH||aR.y+aR.y1>ap.yH){continue}if(!y(aR,ax,d[0])){if(!aw||m(aR,aw)){var aI=aR.sprite,aB=aR.width>>5,aH=d[0]>>5,au=aR.x-(aB<<4),aG=au&31,aQ=32-aG,aM=aR.y1-aR.y0,az=(aR.y+aR.y0)*aH+(au>>5),ay;for(var aJ=0;aJ<aM;aJ++){ay=0;for(var aL=0;aL<=aB;aL++){var at=((ay<<(aQ-1))<<1),aP=aL<aB?(aI[aJ*aB+aL]>>>aG):0;ax[az+aL]|=(at|aP);ay=aI[aJ*aB+aL]}az+=aH}delete aR.sprite;return true}}}return false;function ar(aY,a2){var a1=a2[0],aV=a2[1];canvas1=document.getElementById("paint");canvas1.width=a2[0];canvas1.height=a2[1];var aT=canvas1.getContext("2d");aT.fillStyle="green";var aX=aY.length;for(var aU=0;aU<aX;aU++){var aW=u(aY[aU]);for(var aS=0;aS<32;aS++){if(aW[aS]){var aZ=parseInt((aU*32+aS)/a2[0]);var a0=(aU*32+aS)%a2[0];aT.rect(a0,aZ,1,1)}}}aT.fill()}}function ao(){an();al()}function an(){D.selectAll(".tag").remove()}function al(){var aq=d3.svg.area().x(function(ar){return h(ar.x)}).y0(function(ar){return T(ar.y0)}).y1(function(ar){return T(ar.y0+ar.y)}).interpolate("cardinal");var ap=D.selectAll(".flow").data(F).attr("class","flow").attr("d",aq).style("fill",function(at,ar){if(ar%2==0){return J}return Y}).style("fill-opacity",1)}function ad(){if(w){clearInterval(w)}w=setInterval(af,100);var aq=af();console.log(aq);var ap=D.selectAll("g.tag").data(aq).enter().append("text").attr("class","tag").text(function(ar){return ar.text}).attr("text-anchor","middle").attr("transform",function(ar){return"translate("+[ar.x,ar.y]+")"}).style("font-size",function(ar){return ar.size+"px"}).style("opacity",0.000001).transition().duration(1000).style("opacity",1).style("font-family",function(ar){return ar.font}).style("fill",function(ar){return d3.rgb("black")})}function ah(){ae();var ap=D.selectAll(".flow");switch(f){case"normal":ap.on("click",function(ar,aq){showTopicData(ar.topic_id);populateCategories(ar.topic_id)});break;case"order":ap.call(dragListener);break;case"room":D.call(aj);break;case"fisheye":ap.on("click",function(ar,aq){ak.fisheye(aq)});break;case"category":ap.on("click",function(ar,aq){populateCategories(ar.topic_id)});break;default:break}}function ae(){console.log("in removeListener");var ap=D.selectAll(".flow");ap.on("click",null);ap.on("mousedown.drag",null);ap.on(".force",null);ap.on(".drag",null);ap.on(".zoom",null);D.on("mousedown.zoom",null).on("dblclick.zoom",null).on("wheel.zoom",null).on("mousewheel.zoom",null).on("mousemove.zoom",null).on("touchstart.zoom",null).on("DOMMouseScroll.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null)}function am(){D.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}var aj=d3.behavior.zoom().scaleExtent([0.5,3]).on("zoom",am);function ai(){D.selectAll(".tag").remove();dragStarted=null}dragListener=d3.behavior.drag().on("dragstart",function(ap){dragStarted=true;d3.event.sourceEvent.stopPropagation()}).on("drag",function(aw){if(dragStarted){position_start=d3.mouse(this);ai()}var ar=T.invert(d3.event.y);x_position=h.invert(d3.event.x);if(aw.layer_id<=F.length-1&&aw.layer_id>=0){var ay=$(this).siblings();for(var au=0;au<ay.length;au++){if(ay[au].__data__.layer_id==(aw.layer_id-1)){layer_down=$(ay[au])[0]}if(ay[au].__data__.layer_id==(aw.layer_id+1)){layer_up=$(ay[au])[0]}}if(aw.layer_id>=F.length-1){var av=Number.POSITIVE_INFINITY,aq=(d3.max(layer_down.__data__,function(az){return az.y0})+d3.min(layer_down.__data__,function(az){return az.y0+az.y}))/2}else{if(aw.layer_id<=0){var av=(d3.max(layer_up.__data__,function(az){return az.y0})+d3.min(layer_up.__data__,function(az){return az.y0+az.y}))/2,aq=Number.NEGATIVE_INFINITY}else{var av=(d3.max(layer_up.__data__,function(az){return az.y0})+d3.min(layer_up.__data__,function(az){return az.y0+az.y}))/2,aq=(d3.max(layer_down.__data__,function(az){return az.y0})+d3.min(layer_down.__data__,function(az){return az.y0+az.y}))/2}}if(ar>av){var ap=d3.svg.area().x(function(az){return h(az.x)}).y0(function(az){return T(az.y0)}).y1(function(az){return T(az.y0+az.y)}).interpolate("cardinal");var at=layer_up.__data__.map(function(aA,az){aA.y0=aw[az].y0;return aA});layer_up.__data__.layer_id--;d3.select(layer_up).attr("d",ap(at));aw.map(function(aA,az){aA.y0=at[az].y0+at[az].y});aw.layer_id++}if(ar<aq){var ap=d3.svg.area().x(function(az){return h(az.x)}).y0(function(az){return T(az.y0)}).y1(function(az){return T(az.y0+az.y)}).interpolate("cardinal");var at=layer_down.__data__.map(function(aB,aA){var az=aB.y0;aB.y0=aw[aA].y0+aw[aA].y-aB.y;aw[aA].y0=az;return aB});layer_down.__data__.layer_id++;d3.select(layer_down).attr("d",ap(layer_down.__data__));aw.layer_id--}}var ax=d3.select(this);d3.select(this).attr("transform","translate("+0+","+(d3.event.y-position_start[1])+")")}).on("dragend",function(aq){d3.select(this).attr("transform",null);var ap=d3.svg.area().x(function(ar){return h(ar.x)}).y0(function(ar){return T(ar.y0)}).y1(function(ar){return T(ar.y0+ar.y)}).interpolate("cardinal");d3.select(this).attr("d",ap(aq))});function ag(){if(w){clearInterval(w)}w=setInterval(af,100);var aq=af();var ap=D.selectAll("g.tag").data(aq).enter().append("text").attr("class","tag").text(function(ar){return ar.text}).attr("text-anchor","middle").attr("transform",function(ar){return"translate("+[ar.x,ar.y]+")"}).style("font-size",function(ar){return ar.size+"px"}).style("opacity",0.000001).transition().duration(1000).style("opacity",1).style("font-family",function(ar){return ar.font}).style("fill",function(ar){return d3.rgb("black")})}ak.size=function(ap){if(!arguments.length){return d}d=ap;d[0]=ap[0];return ak};ak.topics=function(ap){if(!arguments.length){return M}M=ap;return ak};ak.color=function(ap){if(!arguments.length){return s}s=ap;return ak};ak.keywordWeight=function(ap){if(!arguments.length){return E}E=ap;return ak};ak.fisheye=function(ap){if(!arguments.length){return L}L=ap;H(ap);ao();ak.updateViz();return ak};ak.section=function(ap){if(!arguments.length){return n}n=ap;return ak};ak.topicSize=function(ap){if(!arguments.length){return n}r=ap;return ak};ak.mode=function(ap){if(!arguments.length){return f}f=ap;ah();return ak};ak.presentTags=function(){ad()};ak.updateViz=function(){an();al()};d3.rebind(ak,ac,"on");return ak};function j(c){return c.word}function C(){return"serif"}function R(){return"normal"}function K(ad){var c=d3.scale.linear().domain([0,0.1]).range(E);return c(ad.wordWeight)}function a(){return 1}function H(ad){var c=d3.layout.stack();c(F.map(function(ag,af){return ag.map(function(ah){if(af==ad){ah.y=ah.y*4}else{ah.y=ah.y*1}delete ah.y0;return ah})}));var ae=d3.max(F[r-1],function(af){return af.y+af.y0});F.map(function(af){af.map(function(ag){ag.y=ag.y/ae;ag.y0=ag.y0/ae})})}function A(c){s[c]=d3.rgb.brighter(s[c]);return s[c]}function aa(ae){var c=d3.layout.stack();var ad=c(ae.slice(0,r).map(function(af){return U(af.periods)}));maxHigh=d3.max(ad[r-1],function(af){return af.y+af.y0});ad.map(function(ag,af){ag.topic_id=af;ag.layer_id=af;ag.map(function(ah){ah.y=ah.y/maxHigh;ah.y0=ah.y0/maxHigh;return ah});return ag});return ad}function U(ai){var ae=ai.map(function(al,ak){return{x:ak,y:al.weight}});var c=new Array();var aj=n[0],ag=n[1];for(var af=aj,ah=0;af<=ag;af++,ah++){var ad=new Object();ad.x=ah;if(af==0){ad.y=(ae[af].y+ae[af+1].y)/2}else{ad.y=(ae[af-1].y+ae[af].y)/2}c.push(ad)}var ad=new Object();ad.x=ah;if(af==ae.length){ad.y=(ae[ae.length-1].y+ae[ae.length-2].y)/2}else{ad.y=(ae[af].y+ae[af-1].y)/2}c.push(ad);return c}function S(){if(n==null){return[0,M[0].periods.length-1]}return n}function B(){if(r==null){return M.length}return r}function g(ay,ak){var az=d3.scale.linear().domain([0,ay.length-1]).range([0,ak[0]]);var ae=d3.scale.linear().domain([0,1]).range([ak[1],0]);var at;if(typeof document!=="undefined"){at=document.createElement("canvas");at.width=ak[0]/G;at.height=ak[1]/G}else{var an=require("canvas");at=new an(ak[0],ak[1])}var ap=at.getContext("2d");var aj=[],al=[];var c=ay.length;for(var ax=0;ax<c;ax++){aj[2*ax]=az(ay[ax].x);aj[2*ax+1]=ae(ay[ax].y0);al[2*ax]=az(ay[c-ax-1].x);al[2*ax+1]=ae(ay[c-ax-1].y0+ay[c-ax-1].y)}ap.beginPath();ap.moveTo(aj[0],aj[1]);ap.curve(aj,0.5,0,true).stroke();ap.curve(al,0.5,0,true).stroke();ap.closePath();ap.stroke();ap.fillStyle="red";ap.fill();var ag=i((ak[0]>>5)*ak[1]);var am=ap.getImageData(0,0,ak[0]/G,ak[1]/G).data;var ai=ak[0],ad=ai>>5,av=ak[1];for(var ar=0;ar<av;ar++){for(var au=0;au<ai;au++){var aq=ad*ar+(au>>5),ao=am[(ar*ai+au)<<2]?1<<(31-(au%32)):0;ag[aq]|=ao}}var ah=ag.length;for(var aw=0;aw<ah;aw++){ag[aw]=~ag[aw]}return ag;function af(){canvas1=document.getElementById("paint");canvas1.width=ai;canvas1.height=av;var aF=canvas1.getContext("2d");aF.fillStyle="green";var aC=ag.length;for(var aE=0;aE<aC;aE++){var aB=u(ag[aE]);for(var aD=0;aD<32;aD++){if(aB[aD]){var aG=parseInt((aE*32+aD)/ai);var aA=(aE*32+aD)%ai;aF.rect(aA,aG,1,1)}}}aF.fill()}}function u(ae){var c=[];for(var ad=0;ad<32;ad++){c[31-ad]=ae%2;ae>>=1}return c}function Q(){var ad,ae=1;if(typeof document!=="undefined"){ad=document.createElement("canvas");ad.width=1;ad.height=1;ad.width=(o<<5)/ae;ad.height=x/ae}else{ad=new Canvas(o<<5,x)}var af=ad.getContext("2d");af.fillStyle=af.strokeStyle="red";af.textAlign="center";return af}function b(av,aw,au){if(av.sprite){return}ab.clearRect(0,0,(o<<5)/G,x/G);var ag=0,af=0,ai=0,am=aw.length;--au;while(++au<am){av=aw[au];ab.save();ab.font=av.style+" "+av.weight+" "+~~((av.size+1)/G)+"px "+av.font;var ah=ab.measureText(av.text+"m").width*G,at=av.size<<1;ah=(ah+31)>>5<<5;if(at>ai){ai=at}if(ag+ah>=(o<<5)){ag=0;af+=ai;ai=0}if(af+at>=x){break}ab.translate((ag+(ah>>1))/G,(af+(at>>1))/G);ab.fillText(av.text,0,0);ab.restore();av.width=ah;av.height=at;av.xoff=ag;av.yoff=af;av.x1=ah>>1;av.y1=at>>1;av.x0=-av.x1;av.y0=-av.y1;av.hasText=true;ag+=ah}var aj=ab.getImageData(0,0,(o<<5)/G,x/G).data,al=[];while(--au>=0){av=aw[au];if(!av.hasText){continue}var ah=av.width,ad=ah>>5,at=av.y1-av.y0,ak=av.padding;for(var ar=0;ar<at*ad;ar++){al[ar]=0}ag=av.xoff;if(ag==null){return}af=av.yoff;var c=0,aq=-1;for(var ap=0;ap<at;ap++){for(var ar=0;ar<ah;ar++){var ao=ad*ap+(ar>>5),an=aj[((af+ap)*(o<<5)+(ag+ar))<<2]?1<<(31-(ar%32)):0;if(ak){if(ap){al[ao-ad]|=an}if(ap<ah-1){al[ao+ad]|=an}an|=(an<<1)|(an>>1)}al[ao]|=an;c|=an}if(c){aq=ap}else{av.y0++;at--;ap--;af++}}av.y1=av.y0+aq;av.sprite=al.slice(0,(av.y1-av.y0)*ad)}function ae(aD){canvas1=document.getElementById("paint");canvas1.width=ah;canvas1.height=at;var aC=canvas1.getContext("2d");aC.fillStyle="green";var az=aD.sprite.length;for(var aB=0;aB<az;aB++){var ay=u(aD.sprite[aB]);for(var aA=0;aA<32;aA++){if(ay[aA]){var aE=parseInt((aB*32+aA)/aD.width);var ax=(aB*32+aA)%aD.width;aC.rect(ax,aE,1,1)}}}aC.fill()}}function y(aq,ai,am){am>>=5;var ap=aq.sprite,al=aq.width>>5,c=aq.x-(al<<4),ak=c&127,ah=32-ak,ag=aq.y1-aq.y0,aj=(aq.y+aq.y0)*am+(c>>5),ao;for(var ae=0;ae<ag;ae++){ao=0;for(var af=0;af<=al;af++){var ad=((ao<<(ah-1))<<1),an=af<al?(ap[ae*al+af]>>>ak):0;if((ad|an)&ai[aj+af]){return true}ao=ap[ae*al+af]}aj+=am}return false}function q(ae,af){var ad=ae[0],c=ae[1];if(af.x+af.x0<ad.x){ad.x=af.x+af.x0}if(af.y+af.y0<ad.y){ad.y=af.y+af.y0}if(af.x+af.x1>c.x){c.x=af.x+af.x1}if(af.y+af.y1>c.y){c.y=af.y+af.y1}}function m(ad,c){return ad.x+ad.x1>c[0].x&&ad.x+ad.x0<c[1].x&&ad.y+ad.y1>c[0].y&&ad.y+ad.y0<c[1].y}function O(c){var ad=c[0]/c[1];return function(ae){return[ad*(ae*=0.1)*Math.cos(ae),ae*Math.sin(ae)]}}function N(af){var ad=4,ae=ad*af[0]/af[1],c=0,ag=0;return function(ai){var ah=ai<0?-1:1;switch((Math.sqrt(1+4*ah*ai)-ah)&3){case 0:c+=ae;break;case 1:ag+=ad;break;case 2:c-=ae;break;default:ag-=ad;break}return[c,ag]}}function i(ae){var c=[],ad=-1;while(++ad<ae){c[ad]=0}return c}function P(c){var ad=c[0]/c[1];return function(ae){return[ad*(ae*=0.1)*Math.cos(ae),ae*Math.sin(ae)]}}})();