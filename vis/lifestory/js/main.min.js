function show(){var d=document.getElementById("custom");var c=document.getElementById("custom-icon").style.backgroundImage;d.style.display=="none"?d.style.display="":d.style.display="none"}function getUrlParam(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)");var c=window.location.search.substr(1).match(b);if(c!=null){return unescape(c[2])}return null}$("#generate_url_text").val("<iframe>"+window.location+"</iframe>");var svg;var svg2;var lifespan;var features;var w=1000;var w2=400;var h=1000;var h2=1000;var padding=150;var selectcolor;var selectmapcolor;var selectpiecolor;var fontresult;var dataset;var dataset2;var nameresult="竺可桢";var result1=1890;var result2=1974;var file_name="event";var file2_name="work";var eventcategory=[];var eventcategorycount=[];var centroid;var centroid2;var angle;var monthangle;var wx=[];var wy=[];var worklist=[];var locationcount=[];var innerRadius=w/2-padding-50;var invertinnerRadius=-w/2+padding+60;var outerRadius=w/2-padding;var interval=30;var xposition=[];var yposition=[];var color=d3.scale.category20();var projection=d3.geo.mercator().center([107,38]).scale(4400).translate([w/2,h/2]);var path=d3.geo.path().projection(projection);var rScale=d3.scale.linear().range([0,15]);var tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);function init(){console.log(file_name);if(selectcolor==undefined){selectcolor="#4682B4"}if(selectmapcolor==undefined){selectmapcolor="#4682B4"}if(selectpiecolor==undefined){selectpiecolor="#2a6799"}if(fontresult==undefined){fontresult="chitext-1"}d3.csv("./data/"+file_name+".csv",function(c){c.forEach(function(g){if(g.month==""){g.month="6";g.lack="Y"}else{g.lack="N"}var e=g.year;if(e.indexOf("~")>=0){var f=e.split("~");g.year=f[0];g.year2=f[1];g.duration="Y"}else{g.year2="";g.duration="N"}if(eventcategory.indexOf(g.category)<0){eventcategory.push(g.category)}});for(var a=0;a<eventcategory.length;a++){eventcategorycount.push(0)}c.forEach(function(f){for(var e=0;e<eventcategory.length;e++){if(f.category==eventcategory[e]){eventcategorycount[e]++}}});if(svg!=undefined){svg.remove()}if(svg2!=undefined){svg2.remove()}svg=d3.select("#right").append("svg").attr("width",w).attr("height",h);svg2=d3.select("#right2").append("svg").attr("width",w2).attr("height",h2);var b=d3.behavior.zoom().scaleExtent([1,5]).on("zoom",d);features=svg.append("g").attr("width",w).attr("height",h).call(b);function d(){features.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}dataset=c;drawTimeline();drawMap();console.log("out of drawMap");d3.csv("./data/"+file2_name+".csv",function(e){console.log(file2_name);console.log(e);dataset2=e;drawWork();drawPie()})})}init();var drawTimeline=function(){lifespan=result2-result1+1;angle=1.9*Math.PI/lifespan;monthangle=1.9*Math.PI/lifespan/12;for(var b=0;b<eventcategory.length;b++){for(var d=0;d<lifespan*12;d++){for(var d=0;d<lifespan*12;d++){var c=d3.svg.arc().innerRadius(outerRadius+b*interval).outerRadius(outerRadius+(b+1)*interval).startAngle(d*monthangle).endAngle((d+1)*monthangle);var e=features.datum(d).append("g").attr("transform","translate("+w/2+","+h/2+")");e.append("path").attr("fill",function(g,f){if(parseInt(g/12)%2==0){return d3.rgb(selectcolor).darker(1)}else{return d3.rgb(selectcolor).brighter(1)}}).attr("opacity","0.3").attr("stroke","white").attr("stroke-width","1").attr("stroke-width","1").attr("d",c()).on("mouseover",function(f){d3.select(this).attr("fill","#FFB90F");var j=f%12+1;var g=parseInt(f/12)+parseInt(result1);svg.append("text").attr("id","label").attr("class",fontresult).attr("x",w*0.1).attr("y",h*0.15).attr("text-font","20px").text(g.toString()+"年·"+j+"月")}).on("mouseout",function(){d3.select(this).attr("fill",function(g,f){if(parseInt(g/12)%2==0){return d3.rgb(selectcolor).darker(1)}else{return d3.rgb(selectcolor).brighter(1)}}).attr("opacity","0.3");d3.select("#label").remove()})}if(eventcategory.length!=1){features.append("text").style("font-size","17px").attr("class",fontresult).text(eventcategory[b]).attr("x",w/2-40).attr("y",h/2-outerRadius-5-interval*b)}}for(var d=0;d<lifespan;d++){var c=d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius).startAngle(d*angle).endAngle((d+1)*angle);xposition.push(c.centroid()[0]);yposition.push(c.centroid()[1]);var a=d+parseInt(result1);var e=features.datum(d).append("g").attr("transform","translate("+w/2+","+h/2+")");e.append("path").attr("d",c()).attr("fill",selectcolor).attr("stroke","white").attr("stroke-width","1").on("mouseover",function(f){d3.select(this).attr("fill","#FFB90F")}).on("mouseout",function(){d3.select(this).attr("fill",selectcolor)});features.append("text").attr("class","engtext").style("font-size","12px").attr("transform","translate("+w/2+","+h/2+")").attr("x",xposition[d]).attr("y",yposition[d]).text(a.toString())}}};var drawWork=function(){var c=[];for(var f=result1;f<=result2;f++){c.push(0);worklist[f-result1]=new Array()}for(var f=result1;f<=result2;f++){for(var e=0;e<dataset2.length;e++){if(parseInt(dataset2[e].year)==f){c[f-result1]++;worklist[f-result1].push(dataset2[e].workname)}}}lifespan=result2-result1+1;angle=1.9*Math.PI/lifespan;for(var f=0;f<lifespan;f++){wx.push(w/2+(innerRadius+30)*Math.cos(-Math.PI/2+angle*(f+0.5)));wy.push(h/2+(innerRadius+30)*Math.sin(-Math.PI/2+angle*(f+0.5)))}for(var f=0;f<lifespan;f++){var b=d3.scale.linear().domain([0,d3.max(c)]).range([0,2*interval]);var g=b(c[f]);var a=d3.svg.arc().innerRadius(outerRadius+interval*eventcategory.length+10).outerRadius(outerRadius+interval*eventcategory.length+g+10).startAngle(f*angle).endAngle((f+1)*angle);var d=features.datum(f).append("g").attr("id","workarc").attr("transform","translate("+w/2+","+h/2+")");d.append("path").attr("d",a()).attr("fill",d3.rgb(selectcolor).darker(1)).attr("stroke","white").attr("stroke-width","1").style("cursor","pointer").on("mouseover",function(){d3.select(this).attr("fill","#FFB90F")}).on("mouseout",function(){d3.select(this).attr("fill",d3.rgb(selectcolor).darker(1))}).on("click",function(l){var k="";console.log("1");if(worklist[l].length>0){for(var j=0;j<worklist[l].length;j++){k=k+"《"+worklist[l][j]+"》</br>"}}d3.select(this).attr("fill","#FFB90F");tooltip.html(parseInt(l)+parseInt(result1)+"年</br>"+k).style("left",(d3.event.pageX)+"px").style("top",(d3.event.pageY+20)+"px").style("opacity",1)})}};var drawPie=function(){var f=new Array();var s=new Array();dataset2.forEach(function(i){if(s.indexOf(i.publication)<0){s.push(i.publication)}if(f.indexOf(i.category)<0){f.push(i.category)}});var d=new Array();for(var l=0;l<f.length;l++){d[l]=new Array();for(var g=0;g<2;g++){d[l][g]=""}d[l][2]=new Array()}for(var l=0;l<f.length;l++){d[l][0]=f[l];d[l][1]=0}var r=new Array();for(var l=0;l<s.length;l++){r[l]=new Array();for(var g=0;g<2;g++){r[l][g]=""}r[l][2]=new Array()}for(var l=0;l<s.length;l++){r[l][0]=s[l];r[l][1]=0}dataset2.forEach(function(u){for(var j=0;j<s.length;j++){if(s[j]==u.publication){r[j][1]++;r[j][2].push(u.workname)}if(f[j]==u.category){d[j][1]++;d[j][2].push(u.workname)}}});if(s.length>5){r.sort(function(j,i){j=parseInt(j[1]);i=parseInt(i[1]);if(j>i){return -1}else{if(j==i){return 0}else{return 1}}});var o=r.slice(0,5)}console.log(o);console.log(d);var p=[];var c=[];for(var l=0;l<o.length;l++){p.push(o[l][1])}for(var l=0;l<d.length;l++){c.push(d[l][1])}var k=d3.layout.pie();var t=0;var b=100;var n=100;var a=d3.svg.arc().innerRadius(t).outerRadius(b);var m=d3.svg.arc().innerRadius(t).outerRadius(b+8);var e=svg2.append("g").attr("id","publicationpie").selectAll("g").data(k(p)).enter().append("g").attr("transform","translate("+w2/2+","+(b+n)+")");var q=svg2.append("g").attr("id","workcategorypie").selectAll("g").data(k(c)).enter().append("g").attr("transform","translate("+w2/2+","+(b+n+2*b+80)+")");svg2.append("text").text("Publication").attr("class","engtext").style("font-size","18px").attr("class",fontresult).attr("x",w2/2).attr("y",340);svg2.append("text").text("Category").attr("class","engtext").style("font-size","18px").attr("class",fontresult).attr("x",w2/2).attr("y",2*b+n+320);e.append("path").attr("fill",function(u,j){return d3.rgb(selectpiecolor).brighter(j+1)}).attr("d",function(i){return m(i)}).attr("stroke-width","0px");e.append("path").attr("fill",function(u,j){return d3.rgb(selectpiecolor).brighter(j)}).attr("d",function(i){return a(i)}).attr("stroke-width","0px").style("cursor","pointer").on("mouseover",function(){d3.select(this).attr("stroke","yellow").attr("stroke-width","3px")}).on("mouseout",function(){d3.select(this).attr("stroke-width","0px")}).on("click",function(y,v){if("#clistofwork"!=undefined){svg2.select("#clistofwork").remove()}if("#plistofwork"!=undefined){svg2.select("#plistofwork").remove()}var x=svg2.append("g").attr("id","plistofwork");for(var u=0;u<d3.min([12,o[v][2].length]);u++){x.append("text").attr("class",fontresult).text("《"+o[v][2][u]+"》").attr("x",200).attr("y",680+u*25).style("font-size","13px")}});e.append("text").attr("class",fontresult).attr("font-size","14px").attr("fill","white").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").text(function(u,j){return o[j][0]}).attr("transform",function(i){return"translate("+a.centroid(i)+")"}).attr("text-anchor","middle");e.append("text").attr("class",fontresult).attr("font-size","12px").attr("fill","white").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").text(function(u,j){return o[j][1]+"篇"}).attr("transform",function(i){return"translate("+a.centroid(i)+")translate(0,15)"}).attr("text-anchor","middle");q.append("path").attr("fill",function(u,j){return d3.rgb(selectpiecolor).brighter(j+1)}).attr("d",function(i){return m(i)}).attr("stroke-width","0px");q.append("path").attr("fill",function(u,j){return d3.rgb(selectpiecolor).brighter(j)}).attr("d",function(i){return a(i)}).attr("stroke","white").attr("stroke-width","1px").style("cursor","pointer").on("mouseover",function(){d3.select(this).attr("stroke","yellow").attr("stroke-width","3px")}).on("mouseout",function(){d3.select(this).attr("stroke-width","0px")}).on("click",function(y,v){if("#clistofwork"!=undefined){svg2.select("#clistofwork").remove()}if("#plistofwork"!=undefined){svg2.select("#plistofwork").remove()}var x=svg2.append("g").attr("id","clistofwork");for(var u=0;u<d3.min([12,d[v][2].length]);u++){x.append("text").attr("class",fontresult).text("《"+d[v][2][u]+"》").attr("x",200).attr("y",680+u*25).style("font-size","13px")}});q.append("text").attr("class",fontresult).attr("font-size","14px").attr("fill","white").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").text(function(u,j){return d[j][0]}).attr("transform",function(i){return"translate("+a.centroid(i)+")"}).attr("text-anchor","middle");q.append("text").attr("class",fontresult).attr("font-size","12px").attr("fill","white").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").text(function(u,j){return d[j][1]+"篇"}).attr("transform",function(i){return"translate("+a.centroid(i)+")translate(0,15)"}).attr("text-anchor","middle")};function textinput2(){fontresult=$("#fonttext").val();console.log(fontresult);selectcolor="#"+$("#input_color").val();selectmapcolor="#"+$("#input_mapcolor").val();selectpiecolor="#"+$("#input_piecolor").val();init()}function drawMap(){console.log("in drawMap");features.append("clipPath").attr("id","map").append("circle").attr("cx",w/2).attr("cy",h/2).attr("r",innerRadius-10);d3.json("./map/china.json",function(g,f){if(g){return console.error(g)}for(var j=0;j<f.features.length;j++){locationcount.push("0")}dataset.forEach(function(b){for(var a=0;a<f.features.length;a++){if(b.location==f.features[a].properties.name){locationcount[a]++;break}}});rScale.domain([0,d3.max(locationcount)]);var e=d3.rgb(selectmapcolor).brighter(3);var c=d3.rgb(selectmapcolor).darker(2);var d=d3.scale.linear().domain([1,f.features.length]).range([0,1]);var k=d3.interpolate(e,c);features.append("g").attr("id","mappath").attr("clip-path","url(#map)").selectAll("path").data(f.features).enter().append("path").attr("stroke","#ccc").attr("stroke-width",1).attr("d",path).attr("fill",function(b,a){if(locationcount[a]==0){return k(d(a))}else{return"yellow"}});features.append("g").attr("id","locationcount").selectAll("circle").data(f.features).enter().append("circle").attr("cx",function(a){return path.centroid(a)[0]}).attr("cy",function(a){return path.centroid(a)[1]}).attr("r",function(b,a){if(locationcount[a]!=0){return rScale(locationcount[a])+5}else{return 0}}).attr("fill","#ff9c00").style("stroke","#ffc119").style("stroke-width","3px");features.append("g").attr("id","locationcounttext").attr("class",fontresult).style("text-shadow"," 2px 2px 2px rgba(0, 0, 0, 0.5)").selectAll("text").data(f.features).enter().append("text").text(function(a){return a.properties.name}).attr("x",function(a){return path.centroid(a)[0]}).attr("y",function(a){return path.centroid(a)[1]}).attr("font-size",function(b,a){if(locationcount[a]!=0){return rScale(locationcount[a])+5}else{return 0}});features.append("g").attr("id","layout").attr("class",fontresult).style("font-size","22px").append("text").text(nameresult+"生活分布图").attr("text-anchor","middle").attr("x",w/2).attr("y",h/2-innerRadius+40)});drawEvent()}function drawEvent(){var d=[];var c=[];var b=1.9*Math.PI/lifespan;var a=1.9*Math.PI/lifespan/12;console.log(lifespan);console.log(b);console.log(a);console.log(result1);console.log(parseInt(result1));console.log(dataset);dataset.forEach(function(f){var e=(parseInt(f.year)-parseInt(result1))*b+parseInt(f.month)*a-Math.PI/2;d.push(w/2+(outerRadius+interval/2+eventcategory.indexOf(f.category)*interval)*Math.cos(e));c.push(h/2+(outerRadius+interval/2+eventcategory.indexOf(f.category)*interval)*Math.sin(e));if(f.duration=="Y"){f.startangle=(parseInt(f.year)-parseInt(result1))*b;f.stopangle=(parseInt(f.year2)-parseInt(result1))*b}});console.log("-------------------------------");console.log(d);features.append("g").attr("id","eventnode").selectAll("circle").data(dataset).enter().append("circle").attr("class","eventnode").attr("cx",function(f,e){return d[e]}).attr("cy",function(f,e){return c[e]}).attr("r",function(e){if(e.duration=="Y"){return 6}else{return 8}}).attr("fill",function(e){if(e.duration=="Y"){return"#474747"}else{return"#a2a2a2"}}).on("mouseover",function(){d3.select(this).attr("fill","orange").attr("r","12")}).on("mouseout",function(e){if(e.duration=="Y"){d3.select(this).attr("fill","#7b7b7b").attr("r","6")}else{d3.select(this).attr("fill","#a2a2a2").attr("r","8")}}).on("click",function(f,e){console.log(1);if("#locationcount"!=undefined){d3.select("#locationcount").remove()}if("#locationcounttext"!=undefined){d3.select("#locationcount").remove()}if("#highlight"!=undefined){d3.select("#highlight").remove()}if("#highlight2"!=undefined){d3.select("#highlight2").remove()}if("#eventdetail"!=undefined){d3.select("#eventdetail").remove()}if("#eventdetail2"!=undefined){d3.select("#eventdetail2").remove()}if("#eventdetail3"!=undefined){d3.select("#eventdetail3").remove()}if("#location2"!=undefined){d3.select("#location2").remove()}d3.csv("./map/idofshi.csv",function(j,m){if(j){return console.error(j)}var g=1;for(var k=0;k<m.length;k++){if(f.location==m[k].name){d3.json("./map/"+f.location+".json",function(p,n){if(p){return console.error(p)}var i=1;for(var o=0;o<n.length;o++){if(n[o].properties.name==f.location2){features.append("path").attr("id","highlight").datum(n[o]).attr("stroke","white").attr("stroke-width",1).attr("d",path).attr("fill","#FF83FA").attr("opacity","0.6");var r=projection(n[o].properties.cp);var q=features.append("g").attr("id","eventdetail");q.append("image").attr("class","highlightmark").attr("x",r[0]-20).attr("y",r[1]-20).attr("width","25").attr("height","25").attr("xlink:href","img/mark.png");q.append("rect").attr("class","eventbox").attr("x",r[0]+20-f.event.length*6).attr("y",r[1]+20).attr("width",f.event.length*12+50).attr("height","80").attr("rx","8").attr("ry","8");q.append("text").text(f.location2).attr("x",r[0]-50).attr("y",r[1]+50).attr("class",fontresult).style("font-size","14px").style("font-weight","bold");q.append("text").attr("class",fontresult).style("font-size","18px").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").attr("x",r[0]+20).attr("y",r[1]+30+20).text(f.title);if(f.lack=="N"){q.append("text").attr("x",r[0]+120).attr("y",r[1]+30+20).text(f.year+"年"+f.month+"月").attr("class",fontresult).attr("font-size","15px")}else{q.append("text").attr("x",r[0]+120).attr("y",r[1]+30+20).text(f.year+"年").attr("class",fontresult).attr("font-size","15px")}q.append("text").attr("x",r[0]+20+20).attr("y",r[1]+60+20).text(f.event).attr("class",fontresult).attr("font-size","12px");i=0;break}}if(i==1){d3.json("./map/china.json",function(t,v){for(var s=0;s<v.features.length;s++){if(f.location==v.features[s].properties.name){features.append("path").attr("id","highlight2").datum(v.features[s]).attr("stroke","white").attr("stroke-width",2).attr("d",path).attr("fill","#FF83FA").attr("opacity","0.6");centroid2=path.centroid(v.features[s]);centroid2.x=centroid2[0];centroid2.y=centroid2[1];var u=features.append("g").attr("id","eventdetail2");u.append("image").attr("class","highlightmark").attr("x",centroid2.x-20).attr("y",centroid2.y-20).attr("width","25").attr("height","25").attr("xlink:href","img/mark.png");u.append("rect").attr("class","eventbox").attr("x",centroid2.x+20-f.event.length*6).attr("y",centroid2.y+20).attr("width",f.event.length*12+50).attr("height","80").attr("rx","8").attr("ry","8");u.append("text").text(f.location).attr("x",centroid2.x-50).attr("y",centroid2.y+50).attr("class",fontresult).style("font-size","14px").style("font-weight","bold");u.append("text").attr("class",fontresult).style("font-size","18px").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").attr("x",centroid2.x+20).attr("y",centroid2.y+50).text(f.title);if(f.lack=="N"){u.append("text").attr("x",140+centroid2.x-20).attr("y",50+centroid2.y).text(f.year+"年"+f.month+"月").attr("class",fontresult).attr("font-size","15px")}else{u.append("text").attr("x",140+centroid2.x-20).attr("y",50+centroid2.y).text(f.year+"年").attr("class",fontresult).attr("font-size","15px")}u.append("text").attr("x",40+centroid2.x).attr("y",30+centroid2.y+50).text(f.event).attr("class",fontresult).attr("font-size","12px")}}})}});g=0;break}}if(g==1){var l=features.append("g").attr("id","eventdetail3");l.append("rect").attr("class","eventbox").attr("x",w/2+20-f.event.length*6).attr("y",h/2+20).attr("width",f.event.length*12+50).attr("height","80").attr("rx","8").attr("ry","8");l.append("text").text(f.location).attr("x",w/2-30).attr("y",h/2+50).style("class",fontresult).style("font-size","14px").style("font-weight","bold");l.append("text").attr("class",fontresult).style("font-size","18px").style("text-shadow","2px 2px 2px rgba(0, 0, 0, 0.5)").attr("x",w/2+20+20).attr("y",h/2+30+20).text(f.title);if(f.lack=="N"){l.append("text").attr("x",w/2+120).attr("y",h/2+30+20).text(f.year+"年"+f.month+"月").attr("class",fontresult).attr("font-size","15px")}else{l.append("text").attr("x",w/2+120).attr("y",h/2+30+20).text(f.year+"年").attr("class",fontresult).attr("font-size","15px")}l.append("text").attr("x",w/2+20+20).attr("y",h/2+60+20).text(f.event).attr("class",fontresult).attr("font-size","12px")}})});console.log("-------------------------------");dataset.forEach(function(f){if(f.duration=="Y"){var e=d3.svg.arc().innerRadius(outerRadius+eventcategory.indexOf(f.category)*interval+interval/2-2).outerRadius(outerRadius+eventcategory.indexOf(f.category)*interval+interval/2+2).startAngle(parseFloat(f.startangle)).endAngle(parseFloat(f.stopangle));var g=features.datum(f).append("g").attr("transform","translate("+w/2+","+h/2+")");g.append("path").attr("d",e()).attr("fill","#474747").on("mouseover",function(i){d3.select(this).attr("fill","orange");g.append("text").text(i.title).attr("id","arctitle").attr("fill","orange").attr("x",e.centroid()[0]).attr("y",e.centroid()[1]).attr("class",fontresult)}).on("mouseout",function(i){d3.select(this).attr("fill","#474747");if("#arctitle"!=undefined){d3.select("#arctitle").remove()}})}});features.append("g").attr("id","eventtitle").selectAll("text").data(dataset).enter().append("text").attr("class","eventtitle").attr("class",fontresult).text(function(e){return e.title}).attr("x",function(f,e){return d[e]}).attr("y",function(f,e){return c[e]}).on("mouseover",function(){d3.select(this).attr("fill","orange")}).on("mouseout",function(){d3.select(this).attr("fill","black")})};